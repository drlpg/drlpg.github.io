<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Vercel + Supabase 搭建博客数据统计API</title>
      <link href="/posts/api/"/>
      <url>/posts/api/</url>
      
        <content type="html"><![CDATA[<p><img src="https://r2.lpblog.dpdns.org/Qexo/2025/09/25/07.jpg"></p><h1 id="第一步：创建-Supabase-项目"><a href="#第一步：创建-Supabase-项目" class="headerlink" title="第一步：创建 Supabase 项目"></a>第一步：创建 Supabase 项目</h1><h2 id="创建新项目"><a href="#创建新项目" class="headerlink" title="创建新项目"></a>创建新项目</h2><p><a href="https://supabase.com/">前往 supabase</a>，点击“Start your project”→ “New project”创建新项目。</p><p><img src="https://r2.lpblog.dpdns.org/Qexo/2025/09/25/01.jpg"></p><h2 id="记录关键信息"><a href="#记录关键信息" class="headerlink" title="记录关键信息"></a>记录关键信息</h2><p><strong>进入Project Settings，点击 “Data API” 和 “API Keys”，记录以下信息：</strong></p><p>Project URL: [supabase 项目地址]<br>API Key (anon public):  [supabase 项目API秘钥]</p><p><img src="https://r2.lpblog.dpdns.org/Qexo/2025/09/25/02.jpg"></p><h2 id="创建数据表"><a href="#创建数据表" class="headerlink" title="创建数据表"></a>创建数据表</h2><p>进入SQL Editor 执行以下命令：</p><p><img src="https://r2.lpblog.dpdns.org/Qexo/2025/09/25/03.jpg"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建访问记录表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> visits (</span><br><span class="line">  id BIGSERIAL <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">  path <span class="type">VARCHAR</span>(<span class="number">500</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  ip_hash <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  user_agent TEXT,</span><br><span class="line">  referrer <span class="type">VARCHAR</span>(<span class="number">500</span>),</span><br><span class="line">  country <span class="type">VARCHAR</span>(<span class="number">10</span>),</span><br><span class="line">  created_at <span class="type">TIMESTAMP</span> <span class="keyword">WITH</span> <span class="type">TIME</span> ZONE <span class="keyword">DEFAULT</span> NOW()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建索引提升查询性能</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_visits_path <span class="keyword">ON</span> visits(path);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_visits_ip_hash <span class="keyword">ON</span> visits(ip_hash);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_visits_created_at <span class="keyword">ON</span> visits(created_at);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> immutable_date(<span class="type">timestamp</span> <span class="keyword">with</span> <span class="type">time</span> zone) </span><br><span class="line"><span class="keyword">RETURNS</span> <span class="type">date</span> <span class="keyword">AS</span> $$</span><br><span class="line">  <span class="keyword">SELECT</span> $<span class="number">1</span>::<span class="type">date</span>;</span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> <span class="keyword">sql</span> IMMUTABLE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_visits_date <span class="keyword">ON</span> visits(immutable_date(created_at));</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建统计视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">VIEW</span> stats_summary <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">  <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">as</span> total_pv,</span><br><span class="line">  <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> ip_hash) <span class="keyword">as</span> total_uv,</span><br><span class="line">  <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="type">DATE</span>(created_at)) <span class="keyword">as</span> active_days</span><br><span class="line"><span class="keyword">FROM</span> visits;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建每日统计视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">VIEW</span> daily_stats <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">  immutable_date(created_at) <span class="keyword">as</span> <span class="type">date</span>,</span><br><span class="line">  <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">as</span> daily_pv,</span><br><span class="line">  <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> ip_hash) <span class="keyword">as</span> daily_uv</span><br><span class="line"><span class="keyword">FROM</span> visits </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> immutable_date(created_at)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="type">date</span> <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建页面统计视图</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">VIEW</span> page_stats <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">  path,</span><br><span class="line">  <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">as</span> page_pv,</span><br><span class="line">  <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> ip_hash) <span class="keyword">as</span> page_uv</span><br><span class="line"><span class="keyword">FROM</span> visits </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> path</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> page_pv <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 启用行级安全策略（可选，用于数据保护）</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> visits ENABLE <span class="type">ROW</span> LEVEL SECURITY;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建允许插入和查询的策略</span></span><br><span class="line"><span class="keyword">CREATE</span> POLICY &quot;Allow insert visits&quot; <span class="keyword">ON</span> visits <span class="keyword">FOR</span> <span class="keyword">INSERT</span> <span class="keyword">WITH</span> <span class="keyword">CHECK</span> (<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">CREATE</span> POLICY &quot;Allow select visits&quot; <span class="keyword">ON</span> visits <span class="keyword">FOR</span> <span class="keyword">SELECT</span> <span class="keyword">USING</span> (<span class="literal">true</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="检查数据表"><a href="#检查数据表" class="headerlink" title="检查数据表"></a>检查数据表</h2><p>进入项目 Dashboard，点击 “Table Editor”，查看数据表是否创建成功。</p><p><img src="https://r2.lpblog.dpdns.org/Qexo/2025/09/25/04.jpg"></p><h1 id="第二步：部署到-Vercel"><a href="#第二步：部署到-Vercel" class="headerlink" title="第二步：部署到 Vercel"></a>第二步：部署到 Vercel</h1><h2 id="一键部署"><a href="#一键部署" class="headerlink" title="一键部署"></a>一键部署</h2><a href="https://vercel.com/new/clone?repository-url=https://github.com/drlpg/blog-stats" style="display:inline-block; text-align:left;">  <img src="https://vercel.com/button" alt="部署到 Vercel" style="display:block; margin:0;"></a><h2 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h2><p>进入项目 Dashboard，点击 “Settings” → “Environment Variables”，添加以下变量：</p><p><img src="https://r2.lpblog.dpdns.org/Qexo/2025/09/25/06.jpg"></p><table><thead><tr><th>变量名称</th><th>释义</th><th>示例</th></tr></thead><tbody><tr><td>SUPABASE_URL</td><td>你的 Supabase 项目 URL</td><td><a href="https://your-project.supabase.co/">https://your-project.supabase.co</a></td></tr><tr><td>SUPABASE_ANON_KEY</td><td>你的 Supabase Anon Key</td><td>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9…</td></tr><tr><td>ALLOWED_ORIGINS</td><td>允许访问的域名（多个域名以”,”分隔）</td><td><a href="https://yourblog.com/">https://yourblog.com</a></td></tr><tr><td>API_SECRET</td><td>随机字符串作为密钥（最好20位以上）</td><td>blog_stats_secret_2025_xyz123</td></tr></tbody></table><p>添加完成后，在 Deployments 点击 “Redeploy” 重新部署</p><h2 id="测试部署情况"><a href="#测试部署情况" class="headerlink" title="测试部署情况"></a>测试部署情况</h2><p>回到项目 Overview ，访问 API URL，打开API测试页，等待网站数据加载完成。</p><p><img src="https://r2.lpblog.dpdns.org/Qexo/2025/09/25/05.jpg"></p><h1 id="第三步：引用API"><a href="#第三步：引用API" class="headerlink" title="第三步：引用API"></a>第三步：引用API</h1><p>以Hexo-butterfly主题为例，进入博客根目录，打开配置文件_config.butterfly.yml，修改busuanzi API地址：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">busuanzi:</span> <span class="string">https://yourdomain.com/blog-stats.js</span></span><br></pre></td></tr></table></figure><p>重新部署博客，至此，博客数据统计API搭建完成。</p>]]></content>
      
      
      <categories>
          
          <category> API </category>
          
      </categories>
      
      
        <tags>
            
            <tag> api </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
